C51 COMPILER V9.52.0.0   UART1                                                             05/14/2019 16:54:04 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE UART1
OBJECT MODULE PLACED IN .\Obj\UART1.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Application\Source\UART1.c LARGE BROWSE INCDIR(.\Application\Header) DEB
                    -UG OBJECTEXTEND PRINT(.\Lis\UART1.lst) TABS(2) OBJECT(.\Obj\UART1.obj)

line level    source

   1          #include "stc15f2k60s2.h"
   2          #include "PCF85063BTL.h"
   3          #include <stdlib.h>
   4          #include "UART1.h"
   5          #define TBAUD (65536-FOSC/4/BAUD)
   6          #define FOSC 18432000L
   7          #define BAUD 115200
   8          
   9          
  10          
  11          
  12          unsigned char SPI_ReadTime(unsigned char addr);
  13          void SPI_WriteTime(unsigned char val,unsigned char addr);
  14          unsigned char ASCIItoBCD(unsigned char ascii[2]); // time format hh:mm:ss
  15          void SendUART1(unsigned char dat);
  16          
  17          
  18          
  19          
  20          
  21          void initUART1(void)
  22          {
  23   1        SCON=0x50; //0101 0000 8-bit uart,  baud rate variable
  24   1        AUXR |=0x95;//10010101 Timer2 as Baud Rate generator
  25   1        T2L=TBAUD;
  26   1        T2H=TBAUD>>8; 
  27   1        ES=1;           // enable uart1 interrupt
  28   1        EA=1;           // each interrupt source will be enable or disable by setting its interrupt bit
  29   1        //PS=0;           // Serial Port 1 interrupt priority control bit, DS page 561
  30   1      }
  31          
  32          
  33          
  34          
  35           void SendString(char *s)
  36          {
  37   1        while(*s)
  38   1        {
  39   2          SendUART1(*s++);
  40   2        }
  41   1      }
  42          
  43          unsigned char ten(unsigned char BCD)
  44          {
  45   1        return (BCD)>>4;
  46   1      }
  47          unsigned char unit(unsigned char BCD)
  48          {
  49   1      
  50   1        //unit=BCD&0x0f;
  51   1        //dec=ten*10+unit;
  52   1        return BCD&0x0f;
  53   1      }
  54          unsigned char DectoBCD(unsigned char dec)
C51 COMPILER V9.52.0.0   UART1                                                             05/14/2019 16:54:04 PAGE 2   

  55          {
  56   1        
  57   1        return dec;
  58   1      }
  59          //if dat=1, we need to use ASCII value to display "1" on UART1
  60          unsigned char ASCII_Letter(unsigned char dat)
  61          {
  62   1        
  63   1        return dat+48;
  64   1      }
  65          
  66          unsigned char ASCIItoBCD(unsigned char ascii[2]) // time format hh:mm:ss
  67          {
  68   1        unsigned char dec_val,ten, unit;
  69   1        dec_val=atoi(ascii);
  70   1        ten=dec_val/10;
  71   1        unit=dec_val%10;
  72   1        return ten<<4|unit;
  73   1        
  74   1      }
  75          
  76          void SendDecValtoUART(unsigned char dat)
  77          {
  78   1        unsigned char hundred, ten, unit;
  79   1        hundred=dat/100;
  80   1        ten=(dat-hundred*100)/10;
  81   1        unit=dat-hundred*100-ten*10;
  82   1        SendUART1(hundred+48);// ASCII Value
  83   1        SendUART1(ten+48);
  84   1        SendUART1(unit+48);
  85   1        
  86   1      }
  87          
  88          void SendBCDValtoUART(unsigned char dat)
  89          {
  90   1        unsigned char ten, unit;
  91   1        ten=dat/16;
  92   1        unit=dat%16;
  93   1        SendUART1(ten+48);
  94   1        SendUART1(unit+48); 
  95   1        
  96   1      }
  97          // Change to read the ALL the data +/-20mm range and record the data every 0.5mm movement.
  98          void SendSPIDataToUART(unsigned char dat,unsigned long int adr)
  99          {
 100   1        // 4bytes*(81 calib)=324+11
 101   1        if(adr%335==0)
 102   1        {
 103   2          //SendString("\r \n Sample (ADC_SUN,ADC_Cell,calib_pos_floor_float): ");
 104   2          SendString("\r\n");
 105   2          SendDecValtoUART(dat);
 106   2          SendString(";");
 107   2        }
 108   1        //ADC val of solar cell when calib
 109   1        else if(adr%335<324  && adr%335!=0)
 110   1        {
 111   2          SendDecValtoUART(dat);
 112   2          if ((adr%335)%4==3)//  remain 0, 
 113   2          {
 114   3            if(adr%335!=323 && adr%335!=0)
 115   3              SendString("\r\n");// make new line
 116   3            else
C51 COMPILER V9.52.0.0   UART1                                                             05/14/2019 16:54:04 PAGE 3   

 117   3              SendString(";");
 118   3          }
 119   2          else if((adr%335)%4!=3)
 120   2          {
 121   3            SendString(";");
 122   3          }
 123   2          
 124   2        }
 125   1        
 126   1        else if (adr%335>=324)
 127   1        {
 128   2          if(adr%335==324 )
 129   2          {
 130   3            SendString("MM-DD-HH-MN-MAX_CELL_VOL-MAX_CALIB_POS[2]-SUNLIGHT_ADC-ADC_LUT-PosLUT[2] ");
 131   3      
 132   3            SendBCDValtoUART(dat);
 133   3            SendString(",");
 134   3          }
 135   2          else if(adr%335==325)
 136   2          {
 137   3            SendBCDValtoUART(dat);
 138   3            SendString(",");
 139   3          } 
 140   2          else if(adr%335==326)
 141   2          {
 142   3            SendBCDValtoUART(dat);
 143   3            SendString(",");
 144   3          }       
 145   2          else if(adr%335==327)
 146   2          {
 147   3            SendBCDValtoUART(dat);
 148   3            SendString(",");
 149   3          }     
 150   2          else
 151   2          {
 152   3            SendDecValtoUART(dat);
 153   3            SendString(":");
 154   3          }
 155   2        }
 156   1      }
 157          
 158          void SendUART1(unsigned char dat)
 159          {
 160   1        while(busy);
 161   1        busy=1;
 162   1        ACC=dat;
 163   1        SBUF=ACC;
 164   1      }
 165          
 166          
 167          
 168           


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    895    ----
   CONSTANT SIZE    =     83    ----
   XDATA SIZE       =   ----      11
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
C51 COMPILER V9.52.0.0   UART1                                                             05/14/2019 16:54:04 PAGE 4   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
