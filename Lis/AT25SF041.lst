C51 COMPILER V9.52.0.0   AT25SF041                                                         02/22/2019 12:35:03 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE AT25SF041
OBJECT MODULE PLACED IN .\Obj\AT25SF041.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Application\Source\AT25SF041.c LARGE BROWSE INCDIR(.\Application\Header)
                    - DEBUG OBJECTEXTEND PRINT(.\Lis\AT25SF041.lst) TABS(2) OBJECT(.\Obj\AT25SF041.obj)

line level    source

   1          #include "AT25SF041.h"
   2          #include "stc15f2k60s2.h"
   3          void Wait_ms_SPINOR(int ms)
   4          {
   5   1        unsigned int De_Cnt;
   6   1        while( (ms--) != 0)
   7   1        {
   8   2          for(De_Cnt = 0; De_Cnt < 4; De_Cnt++); 
   9   2        }   
  10   1      }
  11          void AT25SF041_ChipErase(void)
  12          {
  13   1        int i;
  14   1        unsigned char opcode;
  15   1        opcode=Chip_Erase;
  16   1        //P4M1|=0x10;
  17   1        //P4M0&=~(1<<4);
  18   1        P4M1&=~(1<<1 |1<<2|1<<3);
  19   1        P4M0|=0x07;
  20   1        AT25SF041_CS_Clr();
  21   1        Wait_ms_SPINOR(1);
  22   1        
  23   1        for( i=0;i<8;i++)
  24   1        {
  25   2              AT25SF041_SCK_Clr();
  26   2              Wait_ms_SPINOR(1);
  27   2              if( (opcode&0x80)==0x80 )      //
  28   2              {
  29   3                  AT25SF041_SDI_Set();
  30   3              } 
  31   2                else
  32   2              {
  33   3                  AT25SF041_SDI_Clr();
  34   3      
  35   3              }
  36   2              Wait_ms_SPINOR(1);    
  37   2              AT25SF041_SCK_Set();
  38   2              Wait_ms_SPINOR(1);
  39   2              opcode <<= 1;                   //
  40   2      
  41   2      
  42   2        }
  43   1        
  44   1        AT25SF041_CS_Set();
  45   1        Wait_ms_SPINOR(10);
  46   1        while(Read_Status_Register_Byte1()&0x01==0x01);
  47   1        
  48   1      }
  49          void AT25SF041_WriteEnable(void)
  50          {
  51   1        int i;
  52   1        unsigned char write_en;
  53   1        write_en=Write_Enable;
  54   1        AT25SF041_CS_Clr();
C51 COMPILER V9.52.0.0   AT25SF041                                                         02/22/2019 12:35:03 PAGE 2   

  55   1      //Wait_ms_SPINOR(1);
  56   1        
  57   1        for( i=0;i<8;i++)
  58   1        {
  59   2              AT25SF041_SCK_Clr();
  60   2              Wait_ms_SPINOR(1);
  61   2              if( (write_en&0x80)==0x80 )      //
  62   2              {
  63   3                  AT25SF041_SDI_Set();
  64   3              } 
  65   2                else
  66   2              {
  67   3                  AT25SF041_SDI_Clr();
  68   3      
  69   3              }
  70   2              Wait_ms_SPINOR(1);    
  71   2              AT25SF041_SCK_Set();
  72   2              Wait_ms_SPINOR(1);
  73   2              write_en <<= 1;                   //
  74   2      
  75   2      
  76   2        }
  77   1        AT25SF041_CS_Set();
  78   1        Wait_ms_SPINOR(1);
  79   1        
  80   1      }
  81          
  82          
  83          void AT25SF041_Write(unsigned char opcode, unsigned long int addr,unsigned char dat)
  84          {
  85   1        int i;
  86   1        AT25SF041_CS_Clr();
  87   1        Wait_ms_SPINOR(1);
  88   1      
  89   1        //////////////////////////////////////////
  90   1        for( i=0;i<8;i++)
  91   1          {
  92   2              AT25SF041_SCK_Clr();
  93   2              Wait_ms_SPINOR(1);
  94   2              if( (opcode&0x80)==0x80 )      //
  95   2              {
  96   3                  AT25SF041_SDI_Set();
  97   3              } 
  98   2                else
  99   2              {
 100   3                  AT25SF041_SDI_Clr();
 101   3      
 102   3              }
 103   2              Wait_ms_SPINOR(1);    
 104   2              AT25SF041_SCK_Set();
 105   2              Wait_ms_SPINOR(1);
 106   2              opcode <<= 1;                   //
 107   2      
 108   2      
 109   2          }
 110   1        // SEND THE ADDR (24-bit)
 111   1        for( i=0;i<24;i++)
 112   1        {
 113   2            AT25SF041_SCK_Clr();
 114   2            Wait_ms_SPINOR(1);
 115   2            if( (addr&0x80)==0x80 )      //
 116   2            {
C51 COMPILER V9.52.0.0   AT25SF041                                                         02/22/2019 12:35:03 PAGE 3   

 117   3                AT25SF041_SDI_Set();
 118   3            } 
 119   2              else
 120   2            {
 121   3                AT25SF041_SDI_Clr();
 122   3      
 123   3            }
 124   2            Wait_ms_SPINOR(1);    
 125   2            AT25SF041_SCK_Set();
 126   2            Wait_ms_SPINOR(1);
 127   2            addr <<= 1;
 128   2      
 129   2        }
 130   1        
 131   1          for( i=0;i<8;i++)
 132   1        {
 133   2            AT25SF041_SCK_Clr();
 134   2            Wait_ms_SPINOR(1);
 135   2            if( (dat&0x80)==0x80 )       //
 136   2            {
 137   3                AT25SF041_SDI_Set();
 138   3            } 
 139   2              else
 140   2            {
 141   3                AT25SF041_SDI_Clr();
 142   3      
 143   3            }
 144   2            Wait_ms_SPINOR(1);    
 145   2            AT25SF041_SCK_Set();
 146   2            Wait_ms_SPINOR(1);
 147   2            dat <<= 1;
 148   2      
 149   2        }
 150   1        ///////////////////////////////////////
 151   1        AT25SF041_CS_Set();
 152   1        Wait_ms_SPINOR(1);
 153   1        
 154   1      }
 155          
 156          char  AT25SF041_Read(unsigned char opcode,unsigned long int addr)
 157          {
 158   1        unsigned char dat=0;
 159   1        int i;
 160   1        AT25SF041_CS_Clr();
 161   1        Wait_ms_SPINOR(1);
 162   1      
 163   1        //////////////////////////////////////////
 164   1        // Send the OPCODE
 165   1        for( i=0;i<8;i++)
 166   1        {
 167   2            AT25SF041_SCK_Clr();
 168   2            Wait_ms_SPINOR(1);
 169   2            if( (opcode&0x80)==0x80 )      //
 170   2            {
 171   3                AT25SF041_SDI_Set();
 172   3            } 
 173   2              else
 174   2            {
 175   3                AT25SF041_SDI_Clr();
 176   3      
 177   3            }
 178   2            Wait_ms_SPINOR(1);    
C51 COMPILER V9.52.0.0   AT25SF041                                                         02/22/2019 12:35:03 PAGE 4   

 179   2            AT25SF041_SCK_Set();
 180   2            Wait_ms_SPINOR(1);
 181   2            opcode <<= 1;                   //
 182   2      
 183   2      
 184   2        }
 185   1        // SEND THE ADDR (24-bit)
 186   1        for( i=0;i<24;i++)
 187   1        {
 188   2            AT25SF041_SCK_Clr();
 189   2            Wait_ms_SPINOR(1);
 190   2            if( (addr&0x80)==0x80 )      //
 191   2            {
 192   3                AT25SF041_SDI_Set();
 193   3            } 
 194   2              else
 195   2            {
 196   3                AT25SF041_SDI_Clr();
 197   3      
 198   3            }
 199   2            Wait_ms_SPINOR(1);    
 200   2            AT25SF041_SCK_Set();
 201   2            Wait_ms_SPINOR(1);
 202   2            addr <<= 1;
 203   2      
 204   2        }
 205   1        /////////////////////////////////////////
 206   1        // Store the output data from NOR FLash
 207   1        Wait_ms_SPINOR(10);
 208   1      
 209   1        AT25SF041_SDO_Set();
 210   1        Wait_ms_SPINOR(2);
 211   1        
 212   1        for( i=0;i<8;i++)
 213   1        {
 214   2            dat <<= 1;                //
 215   2            AT25SF041_SCK_Set();
 216   2            Wait_ms_SPINOR(1);
 217   2            AT25SF041_SCK_Clr();
 218   2            Wait_ms_SPINOR(1);
 219   2      
 220   2            if(AT25SF041_SDO)
 221   2            {
 222   3              // INPUT BIT =1
 223   3              dat |= 0x01;            //
 224   3            }
 225   2      
 226   2            //Wait_ms_SPINOR(1); 
 227   2            //AT25SF041_SCK_Set();
 228   2            //Wait_ms_SPINOR(1);
 229   2      
 230   2        } 
 231   1        
 232   1        ///////////////////////////////////////
 233   1        AT25SF041_CS_Set(); 
 234   1        Wait_ms_SPINOR(1);
 235   1        return dat;
 236   1      
 237   1      }
 238          
 239          
 240          
C51 COMPILER V9.52.0.0   AT25SF041                                                         02/22/2019 12:35:03 PAGE 5   

 241          char Read_Status_Register_Byte1(void)
 242          {
 243   1        unsigned char dat=0,opcode,count=0;
 244   1        int i=0;
 245   1        opcode=Read_Stat_Register_Byte1;
 246   1        AT25SF041_CS_Clr();
 247   1        Wait_ms_SPINOR(1);
 248   1      
 249   1        //////////////////////////////////////////
 250   1        // Send the OPCODE
 251   1        for( i=0;i<8;i++)
 252   1        {
 253   2            AT25SF041_SCK_Clr();
 254   2            Wait_ms_SPINOR(1);
 255   2            if( (opcode&0x80)==0x80 )      //
 256   2            {
 257   3                AT25SF041_SDI_Set();
 258   3            } 
 259   2              else
 260   2            {
 261   3                AT25SF041_SDI_Clr();
 262   3      
 263   3            }
 264   2            Wait_ms_SPINOR(1);    
 265   2            AT25SF041_SCK_Set();
 266   2            Wait_ms_SPINOR(1);
 267   2            opcode <<= 1;                   //
 268   2      
 269   2      
 270   2        }
 271   1      
 272   1        /////////////////////////////////////////
 273   1        // Store the output data from NOR FLash
 274   1        Wait_ms_SPINOR(10);
 275   1      
 276   1        AT25SF041_SDO_Set();
 277   1        Wait_ms_SPINOR(2);
 278   1        for( i=0;i<8;i++)
 279   1        {
 280   2            dat <<= 1;                //
 281   2            AT25SF041_SCK_Set();
 282   2            Wait_ms_SPINOR(1);
 283   2            AT25SF041_SCK_Clr();
 284   2            Wait_ms_SPINOR(1);
 285   2      
 286   2            if(AT25SF041_SDO)
 287   2            {
 288   3              // INPUT BIT =1
 289   3              dat |= 0x01;            //
 290   3            }
 291   2      
 292   2        } 
 293   1        
 294   1        
 295   1        ///////////////////////////////////////
 296   1        AT25SF041_CS_Set(); 
 297   1        Wait_ms_SPINOR(1);
 298   1        return dat;
 299   1      }
 300          
 301          void SPI_NOR_Write_Data(struct data_to_store dat,unsigned long int *addr)
 302          {
C51 COMPILER V9.52.0.0   AT25SF041                                                         02/22/2019 12:35:03 PAGE 6   

 303   1        if(*addr==0)
 304   1        {
 305   2          AT25SF041_WriteEnable();
 306   2          //Wait_ms_SPINOR(50);
 307   2          AT25SF041_ChipErase();
 308   2          Wait_ms_SPINOR(5);
 309   2        }               
 310   1        AT25SF041_WriteEnable();
 311   1        //Wait_ms_SPINOR(50); 
 312   1        AT25SF041_Write(Byte_Page_Program, 0,dat.month);
 313   1        
 314   1        Wait_ms_SPINOR(50); 
 315   1        AT25SF041_WriteEnable();
 316   1        //Wait_ms_SPINOR(50); 
 317   1        AT25SF041_Write(Byte_Page_Program, 1,dat.date); 
 318   1        Wait_ms_SPINOR(50); 
 319   1      
 320   1      
 321   1        AT25SF041_WriteEnable();
 322   1        //Wait_ms_SPINOR(50); 
 323   1        AT25SF041_Write(Byte_Page_Program, 2,dat.hour); 
 324   1        Wait_ms_SPINOR(50); 
 325   1      
 326   1        AT25SF041_WriteEnable();
 327   1        //Wait_ms_SPINOR(50); 
 328   1        AT25SF041_Write(Byte_Page_Program, 3,dat.min);
 329   1        Wait_ms_SPINOR(50); 
 330   1      
 331   1        AT25SF041_WriteEnable();
 332   1        //Wait_ms_SPINOR(50); 
 333   1        AT25SF041_Write(Byte_Page_Program, 4,dat.calib_max_voltage_ADC);    
 334   1        Wait_ms_SPINOR(50); 
 335   1        
 336   1        AT25SF041_WriteEnable();
 337   1        //Wait_ms_SPINOR(50); 
 338   1        AT25SF041_Write(Byte_Page_Program, 5,dat.calib_max_pos_floor);
 339   1        Wait_ms_SPINOR(50); 
 340   1        AT25SF041_WriteEnable();
 341   1        //Wait_ms_SPINOR(50); 
 342   1        AT25SF041_Write(Byte_Page_Program, 6,dat.calib_max_pos_float);
 343   1        Wait_ms_SPINOR(50); 
 344   1        
 345   1        AT25SF041_WriteEnable();
 346   1        //Wait_ms_SPINOR(50); 
 347   1        AT25SF041_Write(Byte_Page_Program, 7,dat.light_ADC);  
 348   1        Wait_ms_SPINOR(50); 
 349   1      
 350   1        /*AT25SF041_WriteEnable();
 351   1        //Wait_ms_SPINOR(50);
 352   1        AT25SF041_Write(Byte_Page_Program, 8,dat.Voltage_at_LUT_pos); 
 353   1        Wait_ms_SPINOR(50); 
 354   1        
 355   1        AT25SF041_WriteEnable();
 356   1        //Wait_ms_SPINOR(50); 
 357   1        AT25SF041_Write(Byte_Page_Program, 9,dat.LUT_max_pos_floor);  
 358   1        Wait_ms_SPINOR(50); 
 359   1        
 360   1        AT25SF041_WriteEnable();
 361   1        //Wait_ms_SPINOR(50); 
 362   1        AT25SF041_Write(Byte_Page_Program, 10,dat.LUT_max_pos_float); 
 363   1        Wait_ms_SPINOR(50); */
 364   1      
C51 COMPILER V9.52.0.0   AT25SF041                                                         02/22/2019 12:35:03 PAGE 7   

 365   1      
 366   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1084    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      37
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
