C51 COMPILER V9.52.0.0   AT25SF041                                                         02/25/2019 17:53:55 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE AT25SF041
OBJECT MODULE PLACED IN .\Obj\AT25SF041.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Application\Source\AT25SF041.c LARGE BROWSE INCDIR(.\Application\Header)
                    - DEBUG OBJECTEXTEND PRINT(.\Lis\AT25SF041.lst) TABS(2) OBJECT(.\Obj\AT25SF041.obj)

line level    source

   1          #include "AT25SF041.h"
   2          #include "stc15f2k60s2.h"
   3          void Wait_ms_SPINOR(int ms)
   4          {
   5   1        unsigned int De_Cnt;
   6   1        while( (ms--) != 0)
   7   1        {
   8   2          for(De_Cnt = 0; De_Cnt < 4; De_Cnt++); 
   9   2        }   
  10   1      }
  11          void AT25SF041_ChipErase(void)
  12          {
  13   1        int i;
  14   1        unsigned char opcode;
  15   1        opcode=Chip_Erase;
  16   1        //P4M1|=0x10;
  17   1        //P4M0&=~(1<<4);
  18   1        P4M1&=~(1<<1 |1<<2|1<<3);
  19   1        P4M0|=0x07;
  20   1        AT25SF041_CS_Set();
  21   1        Wait_ms_SPINOR(50);
  22   1      
  23   1        AT25SF041_CS_Clr();
  24   1        Wait_ms_SPINOR(1);
  25   1      
  26   1        Wait_ms_SPINOR(1);
  27   1        
  28   1        for( i=0;i<8;i++)
  29   1        {
  30   2              AT25SF041_SCK_Clr();
  31   2              Wait_ms_SPINOR(1);
  32   2              if( (opcode&0x80)==0x80 )      //
  33   2              {
  34   3                  AT25SF041_SDI_Set();
  35   3              } 
  36   2                else
  37   2              {
  38   3                  AT25SF041_SDI_Clr();
  39   3      
  40   3              }
  41   2              Wait_ms_SPINOR(1);    
  42   2              AT25SF041_SCK_Set();
  43   2              Wait_ms_SPINOR(1);
  44   2              opcode <<= 1;                   //
  45   2      
  46   2      
  47   2        }
  48   1        
  49   1        AT25SF041_CS_Set();
  50   1        Wait_ms_SPINOR(10);
  51   1        while(Read_Status_Register_Byte1()&0x01==0x01);
  52   1        
  53   1      }
  54          void AT25SF041_WriteEnable(void)
C51 COMPILER V9.52.0.0   AT25SF041                                                         02/25/2019 17:53:55 PAGE 2   

  55          {
  56   1        int i;
  57   1        unsigned char write_en;
  58   1        write_en=Write_Enable;
  59   1        AT25SF041_CS_Set();
  60   1          Wait_ms_SPINOR(50);
  61   1      
  62   1        AT25SF041_CS_Clr();
  63   1        Wait_ms_SPINOR(1);
  64   1      //Wait_ms_SPINOR(1);
  65   1        
  66   1        for( i=0;i<8;i++)
  67   1        {
  68   2              AT25SF041_SCK_Clr();
  69   2              Wait_ms_SPINOR(1);
  70   2              if( (write_en&0x80)==0x80 )      //
  71   2              {
  72   3                  AT25SF041_SDI_Set();
  73   3              } 
  74   2                else
  75   2              {
  76   3                  AT25SF041_SDI_Clr();
  77   3      
  78   3              }
  79   2              Wait_ms_SPINOR(1);    
  80   2              AT25SF041_SCK_Set();
  81   2              Wait_ms_SPINOR(1);
  82   2              write_en <<= 1;                   //
  83   2      
  84   2      
  85   2        }
  86   1        AT25SF041_CS_Set();
  87   1        Wait_ms_SPINOR(1);
  88   1        
  89   1      }
  90          
  91          
  92          void AT25SF041_Write(unsigned char opcode, unsigned long int addr, unsigned char dat)
  93          {
  94   1        int i;
  95   1        AT25SF041_CS_Set();
  96   1          Wait_ms_SPINOR(50);
  97   1      
  98   1        AT25SF041_CS_Clr();
  99   1        Wait_ms_SPINOR(1);
 100   1      
 101   1        //////////////////////////////////////////
 102   1        for( i=0;i<8;i++)
 103   1          {
 104   2              AT25SF041_SCK_Clr();
 105   2              Wait_ms_SPINOR(1);
 106   2              if( (opcode&0x80)==0x80 )      //
 107   2              {
 108   3                  AT25SF041_SDI_Set();
 109   3              } 
 110   2                else
 111   2              {
 112   3                  AT25SF041_SDI_Clr();
 113   3      
 114   3              }
 115   2              Wait_ms_SPINOR(1);    
 116   2              AT25SF041_SCK_Set();
C51 COMPILER V9.52.0.0   AT25SF041                                                         02/25/2019 17:53:55 PAGE 3   

 117   2              Wait_ms_SPINOR(1);
 118   2              opcode <<= 1;                   //
 119   2      
 120   2      
 121   2          }
 122   1        // SEND THE ADDR (24-bit)
 123   1        for( i=0;i<24;i++)
 124   1        {
 125   2            AT25SF041_SCK_Clr();
 126   2            Wait_ms_SPINOR(1);
 127   2            if( (addr&0x00800000)==0x00800000 )      //
 128   2            {
 129   3                AT25SF041_SDI_Set();
 130   3            } 
 131   2              else
 132   2            {
 133   3                AT25SF041_SDI_Clr();
 134   3      
 135   3            }
 136   2            Wait_ms_SPINOR(1);    
 137   2            AT25SF041_SCK_Set();
 138   2            Wait_ms_SPINOR(1);
 139   2            addr <<= 1;
 140   2      
 141   2        }
 142   1        
 143   1          for( i=0;i<8;i++)
 144   1        {
 145   2            AT25SF041_SCK_Clr();
 146   2            Wait_ms_SPINOR(1);
 147   2            if( (dat&0x80)==0x80 )       //
 148   2            {
 149   3                AT25SF041_SDI_Set();
 150   3            } 
 151   2              else
 152   2            {
 153   3                AT25SF041_SDI_Clr();
 154   3      
 155   3            }
 156   2            Wait_ms_SPINOR(1);    
 157   2            AT25SF041_SCK_Set();
 158   2            Wait_ms_SPINOR(1);
 159   2            dat <<= 1;
 160   2      
 161   2        }
 162   1        ///////////////////////////////////////
 163   1        AT25SF041_CS_Set();
 164   1        Wait_ms_SPINOR(1);
 165   1        
 166   1      }
 167          
 168          unsigned char  AT25SF041_Read(unsigned char opcode,unsigned long int addr)
 169          {
 170   1        char dat=0;
 171   1        int i;
 172   1        AT25SF041_CS_Clr();
 173   1        Wait_ms_SPINOR(1);
 174   1      
 175   1        //////////////////////////////////////////
 176   1        // Send the OPCODE
 177   1        for( i=0;i<8;i++)
 178   1        {
C51 COMPILER V9.52.0.0   AT25SF041                                                         02/25/2019 17:53:55 PAGE 4   

 179   2            AT25SF041_SCK_Clr();
 180   2            Wait_ms_SPINOR(1);
 181   2            if( (opcode&0x80)==0x80 )      //
 182   2            {
 183   3                AT25SF041_SDI_Set();
 184   3            } 
 185   2              else
 186   2            {
 187   3                AT25SF041_SDI_Clr();
 188   3      
 189   3            }
 190   2            Wait_ms_SPINOR(1);    
 191   2            AT25SF041_SCK_Set();
 192   2            Wait_ms_SPINOR(1);
 193   2            opcode <<= 1;                   //
 194   2      
 195   2      
 196   2        }
 197   1        // SEND THE ADDR (24-bit)
 198   1        for( i=0;i<24;i++)
 199   1        {
 200   2            AT25SF041_SCK_Clr();
 201   2            Wait_ms_SPINOR(1);
 202   2            if( (addr&0x00800000)==0x00800000 )      //
 203   2            {
 204   3                AT25SF041_SDI_Set();
 205   3            } 
 206   2              else
 207   2            {
 208   3                AT25SF041_SDI_Clr();
 209   3      
 210   3            }
 211   2            Wait_ms_SPINOR(1);    
 212   2            AT25SF041_SCK_Set();
 213   2            Wait_ms_SPINOR(1);
 214   2            addr <<= 1;
 215   2      
 216   2        }
 217   1        /////////////////////////////////////////
 218   1        // Store the output data from NOR FLash
 219   1        Wait_ms_SPINOR(10);
 220   1      
 221   1        AT25SF041_SDO_Set();
 222   1        Wait_ms_SPINOR(2);
 223   1        
 224   1        for( i=0;i<8;i++)
 225   1        {
 226   2            dat <<= 1;                //
 227   2            AT25SF041_SCK_Set();
 228   2            Wait_ms_SPINOR(1);
 229   2            AT25SF041_SCK_Clr();
 230   2            Wait_ms_SPINOR(1);
 231   2      
 232   2            if(AT25SF041_SDO)
 233   2            {
 234   3              // INPUT BIT =1
 235   3              dat |= 0x01;            //
 236   3            }
 237   2      
 238   2            //Wait_ms_SPINOR(1); 
 239   2            //AT25SF041_SCK_Set();
 240   2            //Wait_ms_SPINOR(1);
C51 COMPILER V9.52.0.0   AT25SF041                                                         02/25/2019 17:53:55 PAGE 5   

 241   2      
 242   2        } 
 243   1        
 244   1        ///////////////////////////////////////
 245   1        AT25SF041_CS_Set(); 
 246   1        Wait_ms_SPINOR(1);
 247   1        return dat;
 248   1      
 249   1      }
 250          
 251          
 252          
 253          unsigned char Read_Status_Register_Byte1(void)
 254          {
 255   1        unsigned char dat=0,opcode,count=0;
 256   1        int i=0;
 257   1        opcode=Read_Stat_Register_Byte1;
 258   1        AT25SF041_CS_Clr();
 259   1        Wait_ms_SPINOR(1);
 260   1      
 261   1        //////////////////////////////////////////
 262   1        // Send the OPCODE
 263   1        for( i=0;i<8;i++)
 264   1        {
 265   2            AT25SF041_SCK_Clr();
 266   2            Wait_ms_SPINOR(1);
 267   2            if( (opcode&0x80)==0x80 )      //
 268   2            {
 269   3                AT25SF041_SDI_Set();
 270   3            } 
 271   2              else
 272   2            {
 273   3                AT25SF041_SDI_Clr();
 274   3      
 275   3            }
 276   2            Wait_ms_SPINOR(1);    
 277   2            AT25SF041_SCK_Set();
 278   2            Wait_ms_SPINOR(1);
 279   2            opcode <<= 1;                   //
 280   2      
 281   2      
 282   2        }
 283   1      
 284   1        /////////////////////////////////////////
 285   1        // Store the output data from NOR FLash
 286   1        Wait_ms_SPINOR(10);
 287   1      
 288   1        AT25SF041_SDO_Set();
 289   1        Wait_ms_SPINOR(2);
 290   1        for( i=0;i<8;i++)
 291   1        {
 292   2            dat <<= 1;                //
 293   2            AT25SF041_SCK_Set();
 294   2            Wait_ms_SPINOR(1);
 295   2            AT25SF041_SCK_Clr();
 296   2            Wait_ms_SPINOR(1);
 297   2      
 298   2            if(AT25SF041_SDO)
 299   2            {
 300   3              // INPUT BIT =1
 301   3              dat |= 0x01;            //
 302   3            }
C51 COMPILER V9.52.0.0   AT25SF041                                                         02/25/2019 17:53:55 PAGE 6   

 303   2      
 304   2        } 
 305   1        
 306   1        
 307   1        ///////////////////////////////////////
 308   1        AT25SF041_CS_Set(); 
 309   1        Wait_ms_SPINOR(1);
 310   1        return dat;
 311   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    912    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      23
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
